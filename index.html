<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Pig Scorekeeper</title>
    <!-- Tailwind for styling (no defer to avoid FOUC/ordering issues) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM BEFORE Babel + our JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- iro.js (wheel) -->
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <!-- Babel to run JSX inline -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { background: #0f172a; color: #e2e8f0; }
      input[type=number]::-webkit-outer-spin-button,
      input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      input[type=number] { -moz-appearance: textfield; }
      /* Avoid accidental selection while dragging the wheel */
      .no-select, .no-select * { -webkit-user-select: none; user-select: none; }
    </style>
  </head>
  <body class="bg-slate-900">
    <div id="root"></div>
    <div id="portal-root"></div>

    <script type="text/babel" data-presets="react,env">
      const { useEffect, useMemo, useRef, useState, memo } = React;
      const APP_VERSION = "v50 (header tweak)";
      const MAX_MEMBERS = 3;
      const uid = () => Math.random().toString(36).slice(2, 10);
      const STORAGE_KEY = "pig-grid-v19";
      const sum = (arr) => arr.reduce((a,b)=>a+b, 0);
      const clampInt = (n) => { const x = Math.floor(Number(n)); return Number.isFinite(x) ? x : 0; };
      const hexToRgb = (hex)=>{
        try {
          let h=hex.replace("#","");
          if(h.length===3) h=h.split("").map(c=>c+c).join("");
          return {r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16)};
        } catch(e){ return {r:255,g:255,b:255}; }
      };
      const alpha = (hex, a=0.18) => {
        const {r,g,b} = hexToRgb(hex);
        return `rgba(${r},${g},${b},${a})`;
      };

      // Imperative preview: update CSS variables on the team card without touching React state
      function setTeamCssVars(teamId, hex){
        const el = document.getElementById(`team-${teamId}`);
        if (!el) return;
        el.style.setProperty('--team-color', hex);
        el.style.setProperty('--team-alpha', alpha(hex, 0.18));
      }

      // Persistence
      let saveTimer = null;
      function usePersistedState(initial){
        const [state, setState] = useState(()=>{
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) return { ...initial, ...JSON.parse(raw), history: [] };
          } catch {}
          return initial;
        });
        useEffect(()=>{
          const { history, ...persistable } = state;
          if (saveTimer) clearTimeout(saveTimer);
          saveTimer = setTimeout(()=>{
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(persistable)); } catch {}
          }, 120);
          return () => { if (saveTimer) clearTimeout(saveTimer); };
        }, [state]);
        return [state, setState];
      }

      function useKeepFocus(id, focusedId, selectAll=false, clearSelectAll){
        const ref=useRef(null);
        useEffect(()=>{
          if (focusedId === id && ref.current){
            const el = ref.current; el.focus();
            try {
              if (selectAll && typeof el.select === "function") el.select();
              else {
                const len = (el.value ?? "").length;
                if (typeof el.setSelectionRange === "function") el.setSelectionRange(len, len);
              }
            } catch {}
            if (selectAll && typeof clearSelectAll === "function"){
              setTimeout(()=>clearSelectAll(), 0);
            }
          }
        }, [focusedId, id, selectAll, clearSelectAll]);
        return ref;
      }

      // Portal helper
      function Portal({ children }){
        const elRef = useRef(null);
        if (!elRef.current) elRef.current = document.createElement("div");
        useEffect(()=>{
          const root = document.getElementById("portal-root");
          root.appendChild(elRef.current);
          return () => { root.removeChild(elRef.current); };
        }, []);
        return ReactDOM.createPortal(children, elRef.current);
      }

      // IRO wheel picker rendered in a portal; live preview uses CSS vars (no React setState during drag)
      const WheelPicker = memo(function WheelPicker({ teamId, color, onCommit, onClose }){
        const hostRef = useRef(null);
        const pickerRef = useRef(null);
        const [fallback, setFallback] = useState(false);
        const [hex, setHex] = useState(color);

        useEffect(()=>{
          // Initialize CSS vars to current color
          setTeamCssVars(teamId, color);
        }, [teamId, color]);

        useEffect(()=>{
          let disposed = false;
          function mountIro(){
            if (!window.iro || !hostRef.current) return false;
            try {
              const iro = window.iro;
              const picker = new iro.ColorPicker(hostRef.current, {
                width: 260,
                color: color,
                layout: [
                  { component: iro.ui.Wheel, options: { wheelLightness: true } },
                  { component: iro.ui.Slider, options: { sliderType: "saturation" } },
                  { component: iro.ui.Slider, options: { sliderType: "value" } },
                ],
              });
              // Live preview without React re-render
              const onAnyChange = (c)=>{
                if (disposed) return;
                const h = c.hexString;
                setHex(h);
                setTeamCssVars(teamId, h);
              };
              picker.on("input:change", onAnyChange);
              picker.on("color:change", onAnyChange);
              pickerRef.current = picker;
              return true;
            } catch (e) {
              return false;
            }
          }
          const ok = mountIro();
          if (!ok) setFallback(true);
          return () => {
            disposed = true;
            try { pickerRef.current?.off("input:change"); pickerRef.current?.off("color:change"); pickerRef.current?.destroy(); } catch {}
            pickerRef.current = null;
          };
        }, []);

        // If parent updates color while open, sync the wheel
        useEffect(()=>{
          try { if (pickerRef.current) pickerRef.current.color.hexString = color; } catch {}
        }, [color]);

        const commitAndClose = () => { onCommit(hex); onClose(); };

        return (
          <Portal>
            <div className="fixed inset-0 z-50 no-select">
              <div className="absolute inset-0 bg-black/30" onClick={commitAndClose}></div>
              <div className="relative w-full h-full flex items-start justify-center pt-16">
                <div className="relative p-4 rounded-2xl border border-slate-700 bg-slate-800 shadow-xl w-[360px]">
                  <div className="text-xs text-slate-300 mb-3 flex items-center justify-between">
                    <span>Pick a color</span>
                    <button onClick={commitAndClose} className="px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-700">Close</button>
                  </div>
                  {!fallback ? (
                    <div ref={hostRef} className="mx-auto"></div>
                  ) : (
                    <div className="space-y-3">
                      <div className="text-xs bg-slate-700/50 p-2 rounded">CDN blocked or offline — using native picker.</div>
                      <input type="color" value={hex} onInput={(e)=>{ const h=e.target.value; setHex(h); setTeamCssVars(teamId, h); }} className="w-full h-10 rounded border border-slate-600 bg-slate-800" />
                    </div>
                  )}
                </div>
              </div>
            </div>
          </Portal>
        );
      });

      function App(){
        const [app, setApp] = usePersistedState({
          target: 100,
          teams: [
            { id: uid(), name: "Team A", color: "#38bdf8", members: [
              { id: uid(), name: "Member 1", entries: [] },
              { id: uid(), name: "Member 2", entries: [] },
              { id: uid(), name: "Member 3", entries: [] },
            ]},
            { id: uid(), name: "Team B", color: "#f472b6", members: [
              { id: uid(), name: "Member 1", entries: [] },
              { id: uid(), name: "Member 2", entries: [] },
              { id: uid(), name: "Member 3", entries: [] },
            ]},
          ],
          history: [],
          pending: {},
        });
        const [focusedId, setFocusedId] = useState(null);
        const [pickerForTeam, setPickerForTeam] = useState(null);

        const snapshot = (p) => ({ target: p.target, teams: p.teams, pending: p.pending });
        const pushHistory = (label) => setApp(p => ({ ...p, history: [...p.history.slice(-9), { label, snapshot: snapshot(p), ts: Date.now() }] }));
        const onUndo = () => { if (!app.history.length) return; const last = app.history.at(-1); setApp(p => ({ ...p, ...last.snapshot, history: p.history.slice(0, -1) })); };
        const hardReset = () => {
          if (!confirm("Reset scores (no archive)?")) return;
          setApp(p => ({ ...p, teams: p.teams.map(t => ({ ...t, members: t.members.map(m => ({ ...m, entries: [] })) })), pending: {}, history: [] }));
        };

        const addMember = (teamId) => setApp(p => ({ ...p, teams: p.teams.map(t => t.id === teamId ? { ...t, members: t.members.length>=MAX_MEMBERS ? t.members : [...t.members, { id: uid(), name: `Member ${t.members.length+1}`, entries: [] }] } : t) }));
        const removeMember = (teamId, memberId) => setApp(p => ({ ...p, teams: p.teams.map(t => t.id === teamId ? { ...t, members: t.members.filter(m => m.id !== memberId) } : t) }));
        const renameMember = (teamId, memberId, name) => setApp(p => ({ ...p, teams: p.teams.map(t => t.id === teamId ? { ...t, members: t.members.map(m => m.id === memberId ? { ...m, name } : m) } : t) }));
        const renameTeam = (teamId, name) => setApp(p => ({ ...p, teams: p.teams.map(t => t.id === teamId ? { ...t, name } : t) }));
        const setTeamColor = (teamId, color) => setApp(p => ({ ...p, teams: p.teams.map(t => t.id === teamId ? { ...t, color } : t) }));

        const setPending = (id, value) => setApp(p => ({ ...p, pending: { ...p.pending, [id]: value } }));
        const commitPending = (teamId, memberId) => {
          const raw = app.pending[memberId];
          if (raw == null || String(raw).trim() === "") return;
          const n = clampInt(raw);
          if (n < 0) { setPending(memberId, ""); return; }
          pushHistory("+" + n);
          setApp(p => ({ ...p,
            teams: p.teams.map(t => t.id === teamId ? { ...t, members: t.members.map(m => m.id === memberId ? { ...m, entries: [...m.entries, n] } : m) } : t),
            pending: { ...p.pending, [memberId]: "" }
          }));
        };

        // Tab ordering
        const scoreOrder = useMemo(()=>{
          const teams = app.teams;
          const maxRows = Math.max(0, ...teams.map(t => t.members.length));
          const order = [];
          for (let r=0; r<maxRows; r++) for (const t of teams){ const m=t.members[r]; if(m) order.push({memberId:m.id, teamId:t.id}); }
          return order;
        }, [app.teams]);
        const scoreIndex = useMemo(()=>{ const m=new Map(); scoreOrder.forEach((o,i)=>m.set(o.memberId,i)); return m; }, [scoreOrder]);
        const memberToTeam = useMemo(()=>{ const m=new Map(); scoreOrder.forEach(o=>m.set(o.memberId,o.teamId)); return m; }, [scoreOrder]);
        const nameOrder = useMemo(()=>{ const order=[]; for(const t of app.teams) for(const m of t.members) order.push({memberId:m.id, teamId:t.id}); return order; }, [app.teams]);
        const nameIndex = useMemo(()=>{ const m=new Map(); nameOrder.forEach((o,i)=>m.set(o.memberId,i)); return m; }, [nameOrder]);

        const Header = () => (
          <header className="grid grid-cols-3 items-center mb-4 md:mb-6">
            <div className="justify-self-start">
              <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Pig Scorekeeper</h1>
            </div>
            <div className="justify-self-center">
              <div className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100 text-sm md:text-base whitespace-nowrap">
                <span className="font-semibold">Goal:</span> First to 100 points wins!
              </div>
            </div>
            <div className="justify-self-end flex items-center gap-2">
              <button onClick={onUndo} disabled={!app.history.length} className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100 disabled:opacity-50">Undo</button>
              <button onClick={hardReset} className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100">Reset</button>
            </div>
          </header>
        );

        const TeamCard = ({ team }) => {
          const members = team.members;
          const cols = Math.max(1, members.length);
          const teamNameRef = useKeepFocus(team.id, focusedId);
          const condensed = members.length >= 3;

          // Ensure CSS vars reflect state color on mount/update
          useEffect(()=>{ setTeamCssVars(team.id, team.color); }, [team.id, team.color]);

          return (
            <div id={`team-${team.id}`} className="p-3 md:p-4 rounded-2xl shadow border border-slate-700 bg-slate-800"
                 style={{ boxShadow: '0 0 0 1px var(--team-color)' }}>
              <div className="mb-2 md:mb-3">
                <div className="flex items-center justify-between gap-2 relative">
                  <div className="flex-1" />
                  <div className="flex items-center gap-3 relative">
                    <button onClick={()=>setPickerForTeam(team.id)} className="w-7 h-7 md:w-8 md:h-8 rounded-full border border-slate-700 shrink-0"
                            style={{ background: 'var(--team-color)' }} title="Pick team color"></button>
                    <div className="flex flex-col items-center gap-1">
                      <input tabIndex={-1} ref={teamNameRef} value={team.name}
                        onChange={(e)=>{ setFocusedId(team.id); renameTeam(team.id, e.target.value); }}
                        className="text-xl md:text-3xl font-black tracking-wide px-1 py-1 bg-transparent text-center outline-none border-b-2 border-slate-600 hover:border-slate-500 focus:border-emerald-500 text-slate-100"
                        style={{ width: "16rem" }}
                      />
                      <div className="text-xs font-medium" style={{ color: 'var(--team-color)' }}>Team</div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <button onClick={()=>addMember(team.id)} disabled={members.length>=MAX_MEMBERS} className="px-3 md:px-4 py-2 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-500 h-10 md:h-10 text-sm md:text-base disabled:opacity-50 whitespace-nowrap">Add member</button>
                    <span className="text-xs uppercase tracking-wide opacity-70">{members.length}/{MAX_MEMBERS}</span>
                  </div>
                </div>
              </div>

              <div className="p-2 md:p-3 rounded-2xl shadow border border-slate-700 bg-slate-800 text-center" style={{ boxShadow: '0 0 0 1px var(--team-color)' }}>
                <div className="text-xs md:text-sm uppercase tracking-wide opacity-70">Team total</div>
                {/* Total in white as requested */}
                <div className={`${condensed?'text-6xl md:text-7xl':'text-7xl md:text-8xl'} font-black tabular-nums`} style={{ color: '#fff' }}>
                  {sum(members.map(m => sum(m.entries)))}
                </div>
                {/* Colored badge uses CSS var for live preview */}
                <div className="inline-block px-2 py-1 rounded-lg text-sm md:text-base mt-1"
                     style={{ background: 'var(--team-alpha)', color: 'var(--team-color)' }}>
                  {Math.max(0, 100 - sum(members.map(m => sum(m.entries))))} to 100
                </div>
              </div>

              <div className="mt-3 grid gap-2 md:gap-3" style={{ gridTemplateColumns: `repeat(${cols}, minmax(0, 1fr))` }}>
                {members.map(m => {
                  const nameRef = useKeepFocus(m.id + ":name", focusedId, false, ()=>{});
                  return (
                    <div key={m.id} className="relative p-2 md:p-3 rounded-2xl shadow border border-slate-700 bg-slate-800 text-center"
                         style={{ boxShadow: '0 0 0 1px var(--team-color)' }}>
                      <button onClick={()=>removeMember(team.id,m.id)} className="absolute top-1 right-1 md:top-2 md:right-2 rounded-md border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700 text-[10px] md:text-xs px-1.5 py-0.5" title="Remove member">×</button>
                      <div className="flex items-center justify-center gap-2 mb-1 md:mb-2">
                        <input
                          tabIndex={0}
                          ref={nameRef}
                          value={m.name}
                          onFocus={()=> setFocusedId(m.id + ":name")}
                          onChange={(e)=>{ setFocusedId(m.id + ":name"); renameMember(team.id, m.id, e.target.value); }}
                          onKeyDown={(e) => {
                            if (e.key === "Tab") {
                              e.preventDefault();
                              const idx = nameIndex.get(m.id) ?? -1;
                              const nextIdx = (idx + (e.shiftKey ? -1 : 1) + nameOrder.length) % nameOrder.length;
                              const nextId = nameOrder[nextIdx]?.memberId;
                              if (nextId) { setFocusedId(nextId + ":name"); }
                            }
                          }}
                          className={`font-bold ${condensed?'text-base md:text-xl':'text-xl md:text-2xl'} px-1 py-1 bg-transparent text-center outline-none border-b-2 border-slate-600 hover:border-slate-500 focus:border-emerald-500 text-slate-100`}
                          style={{ width: condensed ? "8rem" : "12rem" }}
                        />
                      </div>
                      <div className="text-[10px] md:text-xs uppercase tracking-wide opacity-70">Subtotal</div>
                      <div className={`${condensed?'text-3xl md:text-4xl':'text-4xl md:text-5xl'} font-bold tabular-nums`}>{sum(m.entries)}</div>
                    </div>
                  );
                })}
              </div>

              <div className="mt-3 grid gap-2 md:gap-3" style={{ gridTemplateColumns: `repeat(${cols}, minmax(0, 1fr))` }}>
                {members.map(m => {
                  const scoreRef = useKeepFocus(m.id + ":score", focusedId);
                  return (
                    <div key={m.id} className="p-2 md:p-3 rounded-2xl shadow border border-slate-700 bg-slate-800">
                      <div className="text-[10px] md:text-xs uppercase tracking-wide opacity-70 mb-1 text-center">Per-turn</div>
                      <ul className="min-h-[1.25rem] md:min-h-[1.75rem] space-y-0.5 max-h-24 md:max-h-28 overflow-auto pr-1">
                        {m.entries.map((v, i) => (<li key={i} className="text-[11px] md:text-sm tabular-nums">{v}</li>))}
                      </ul>
                      <div className="mt-2 flex items-center gap-2">
                        <input
                          ref={scoreRef}
                          type="number"
                          inputMode="numeric"
                          value={app.pending[m.id] ?? ""}
                          onFocus={() => setFocusedId(m.id + ":score")}
                          onChange={(e) => { setPending(m.id, e.target.value); }}
                          onKeyDown={(e) => {
                            if (e.key === "Enter") { commitPending(memberToTeam.get(m.id), m.id); setFocusedId(m.id + ":score"); }
                            else if (e.key === "Tab") {
                              e.preventDefault();
                              commitPending(memberToTeam.get(m.id), m.id);
                              const idx = scoreIndex.get(m.id) ?? -1;
                              const nextIdx = (idx + (e.shiftKey ? -1 : 1) + scoreOrder.length) % scoreOrder.length;
                              setFocusedId(scoreOrder[nextIdx].memberId + ":score");
                            }
                          }}
                          className={`${(members.length>=3)?'basis-1/2 grow-0 w-1/2':'flex-1'} min-w-0 px-2 md:px-3 py-2 md:py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-600 ${(members.length>=3)?'h-10 text-sm md:text-sm':'h-12 md:h-10 text-lg md:text-base'}`}
                          placeholder="score"
                        />
                        <button
                          onClick={() => { pushHistory("undo member last"); setApp(p => ({ ...p, teams: p.teams.map(t => t.id === memberToTeam.get(m.id) ? { ...t, members: t.members.map(x => x.id === m.id ? { ...x, entries: x.entries.slice(0, -1) } : x) } : t) })); }}
                          className="w-10 h-10 grid place-items-center rounded-2xl border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700 text-base"
                          title="Undo last" aria-label="Undo last">↶</button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        };

        return (
          <div className="min-h-screen w-full text-slate-100 p-3 md:p-6">
            <div className="max-w-7xl mx-auto">
              <Header />
              <div className="grid md:grid-cols-2 gap-6">
                {app.teams.map(t => <TeamCard key={t.id} team={t} />)}
              </div>
            </div>
            <div className="fixed right-3 bottom-3 z-40 text-xs text-slate-400 opacity-70 select-none">{APP_VERSION}</div>

            {pickerForTeam && (
              <WheelPicker
                teamId={pickerForTeam}
                color={app.teams.find(t=>t.id===pickerForTeam)?.color || "#38bdf8"}
                onCommit={(hex)=> setTeamColor(pickerForTeam, hex)}
                onClose={()=> setPickerForTeam(null)}
              />
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
