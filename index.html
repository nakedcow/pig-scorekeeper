<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Pig Scorekeeper</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- iro.js for color wheel -->
  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { background:#0f172a; color:#e2e8f0; }
    .no-focus-outline:focus { outline: none; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }
  </style>
</head>
<body class="bg-slate-900">
  <div id="root"><div class="p-6 text-slate-100">Loading‚Ä¶</div></div>
  <div id="portal-root"></div>

<script type="text/babel" data-presets="env,react">
// ---------- utils ----------
const {useState,useEffect,useMemo,useRef,memo} = React;
const APP_VERSION = "V2.01 (winner animation)";
const MAX_MEMBERS = 3;
const uid = () => Math.random().toString(36).slice(2,10);
const STORAGE_KEY = "pig-grid-v20"; // bump storage key for 2.x
const sum = (a)=>a.reduce((x,y)=>x+y,0);
const clampInt = (n)=>{ const x = Math.floor(Number(n)); return Number.isFinite(x)?x:0; };

// ---------- error banner (so we never see just a blank screen) ----------
window.addEventListener("error", (e)=>{
  const pre = document.createElement("pre");
  pre.style.cssText = "position:fixed;left:8px;bottom:8px;right:8px;max-height:40vh;overflow:auto;background:#111827;color:#fca5a5;border:1px solid #374151;border-radius:12px;padding:8px;z-index:99999;font-size:12px;";
  pre.textContent = "JS error: " + (e.message||e.error||"") + "\n(See console for details)";
  document.body.appendChild(pre);
}, { once:true });

// ---------- storage hook ----------
function usePersistedState(initial){
  const [state,setState] = useState(()=>{
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const loaded = Object.assign({}, initial, JSON.parse(raw));
        loaded.teams = (loaded.teams||initial.teams).map(t=>({
          id: t.id||uid(),
          name: t.name||"Team",
          color: t.color||"#38bdf8",
          teamEntries: Array.isArray(t.teamEntries)?t.teamEntries:[],
          members: (t.members||[]).map(m=>({ id:m.id||uid(), name:m.name||"Member", entries:Array.isArray(m.entries)?m.entries:[] }))
        }));
        loaded.winnerTeamId = loaded.winnerTeamId ?? null;
        loaded.history = []; // don't hydrate history
        return loaded;
      }
    }catch{}
    return initial;
  });
  useEffect(()=>{
    const {history, ...persist} = state;
    const id = setTimeout(()=>{ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(persist)); }catch{} }, 100);
    return ()=> clearTimeout(id);
  },[state]);
  return [state,setState];
}

// ---------- portal ----------
function Portal({ children }){
  const elRef = useRef(null);
  if (!elRef.current) elRef.current = document.createElement("div");
  useEffect(()=>{
    const root = document.getElementById("portal-root");
    root.appendChild(elRef.current);
    return ()=> { root.removeChild(elRef.current); };
  },[]);
  return ReactDOM.createPortal(children, elRef.current);
}

// ---------- color wheel ----------
const WheelPicker = memo(function WheelPicker({ initial, onInput, onClose }){
  const hostRef = useRef(null);
  const pickerRef = useRef(null);
  const [fallback, setFallback] = useState(false);

  useEffect(()=>{
    if (!window.iro || !hostRef.current) { setFallback(true); return; }
    try {
      const iro = window.iro;
      const picker = new iro.ColorPicker(hostRef.current, {
        width: 260,
        color: initial,
        layout: [
          { component: iro.ui.Wheel, options: { wheelLightness: true } },
          { component: iro.ui.Slider, options: { sliderType: "saturation" } },
          { component: iro.ui.Slider, options: { sliderType: "value" } },
        ],
      });
      const onAny = (c)=> onInput && onInput(c.hexString);
      picker.on("input:change", onAny);
      picker.on("color:change", onAny);
      pickerRef.current = picker;
    } catch(e){ setFallback(true); }
    return ()=>{
      try {
        if (pickerRef.current) {
          pickerRef.current.off("input:change");
          pickerRef.current.off("color:change");
          pickerRef.current.destroy();
        }
      } catch {}
      pickerRef.current = null;
    };
  },[]);

  return (
    <Portal>
      <div className="fixed inset-0 z-50">
        <div className="absolute inset-0 bg-black/40" onClick={onClose}></div>
        <div className="relative w-full h-full flex items-start justify-center pt-16">
          <div className="relative p-4 rounded-2xl border border-slate-700 bg-slate-800 shadow-xl w-[360px]">
            <div className="text-xs text-slate-300 mb-3 flex items-center justify-between">
              <span>Pick a color</span>
              <button onClick={onClose} className="px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-700">Close</button>
            </div>
            {!fallback ? (
              <div ref={hostRef} className="mx-auto"></div>
            ) : (
              <div className="space-y-2">
                <div className="text-xs bg-slate-700/50 p-2 rounded">CDN blocked ‚Äî using native picker.</div>
                <input type="color" defaultValue={initial} onInput={(e)=>onInput && onInput(e.target.value)} className="w-full h-10 rounded border border-slate-600 bg-slate-800"/>
              </div>
            )}
          </div>
        </div>
      </div>
    </Portal>
  );
});

// ---------- Winner Overlay with Confetti ----------
const WinnerOverlay = memo(function WinnerOverlay({ team, onClose, onReset }){
  const canvasRef = useRef(null);
  const animRef = useRef(0);
  const piecesRef = useRef([]);
  const startRef = useRef(null);
  const [visible, setVisible] = useState(true);

  useEffect(()=>{
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const DPR = Math.min(2, window.devicePixelRatio || 1);
    const resize = ()=>{
      canvas.width = Math.floor(window.innerWidth * DPR);
      canvas.height = Math.floor(window.innerHeight * DPR);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
    };
    resize();
    window.addEventListener("resize", resize);
    // init confetti
    const colors = [team?.color || "#22c55e", "#fde047", "#60a5fa", "#f87171", "#a78bfa"];
    const pieces = [];
    for(let i=0;i<180;i++){
      pieces.push({
        x: Math.random()*canvas.width,
        y: -Math.random()*canvas.height*0.5,
        r: 3 + Math.random()*6,
        dx: -2 + Math.random()*4,
        dy: 2 + Math.random()*3,
        tilt: Math.random()*Math.PI*2,
        dtilt: -0.1 + Math.random()*0.2,
        color: colors[i%colors.length],
      });
    }
    piecesRef.current = pieces;
    startRef.current = performance.now();
    const tick = (t)=>{
      const ctx = canvas.getContext("2d");
      const elapsed = t - startRef.current;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(const p of piecesRef.current){
        p.tilt += p.dtilt;
        p.x += p.dx;
        p.y += p.dy;
        p.dy += 0.02; // gravity
        // wrap sideways
        if (p.x < -20) p.x = canvas.width + 20;
        if (p.x > canvas.width + 20) p.x = -20;
        // draw
        ctx.save();
        ctx.fillStyle = p.color;
        ctx.translate(p.x, p.y);
        ctx.rotate(p.tilt);
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      }
      animRef.current = requestAnimationFrame(tick);
      if (elapsed > 6000) { cancelAnimationFrame(animRef.current); }
    };
    animRef.current = requestAnimationFrame(tick);
    return ()=>{
      cancelAnimationFrame(animRef.current);
      window.removeEventListener("resize", resize);
    };
  }, [team?.color]);

  useEffect(()=>{
    const t = setTimeout(()=> setVisible(false), 6500);
    return ()=> clearTimeout(t);
  },[]);

  if (!visible) return null;

  return (
    <Portal>
      <div className="fixed inset-0 z-[100]">
        <canvas ref={canvasRef} className="absolute inset-0 pointer-events-none"></canvas>
        <div className="absolute inset-0 bg-black/40"></div>
        <div className="relative h-full w-full flex items-center justify-center p-4">
          <div className="text-center p-6 rounded-3xl border border-slate-700 shadow-2xl" style={{ background:"rgba(2,6,23,0.85)", boxShadow:`0 0 0 2px ${team?.color||"#22c55e"} inset` }}>
            <div className="text-6xl md:text-7xl mb-2">üèÜ</div>
            <div className="text-xl md:text-2xl uppercase tracking-widest text-slate-300">Winner</div>
            <div className="text-3xl md:text-5xl font-black tabular-nums" style={{ color: team?.color||"#22c55e" }}>{team?.name || "Team"}</div>
            <div className="mt-4 flex items-center justify-center gap-3">
              <button onClick={onReset} className="px-4 py-2 rounded-xl border border-slate-700 bg-slate-800 hover:bg-slate-700">Reset</button>
              <button onClick={onClose} className="px-4 py-2 rounded-xl border border-slate-700 bg-slate-800 hover:bg-slate-700">Close</button>
            </div>
          </div>
        </div>
      </div>
    </Portal>
  );
});

// ---------- small pieces ----------
const TeamNameInput = memo(function TeamNameInput({ value, onCommit }){
  const [draft, setDraft] = useState(value);
  useEffect(()=>{ setDraft(value); },[value]);
  return (
    <input
      value={draft}
      onChange={(e)=> setDraft(e.target.value)}
      onBlur={()=> onCommit(draft)}
      onKeyDown={(e)=>{ if(e.key==="Enter"||e.key==="Tab"){ e.preventDefault(); onCommit(draft); } }}
      className="text-xl md:text-3xl font-black tracking-wide px-1 py-1 bg-transparent text-center outline-none border-b-2 border-slate-600 hover:border-slate-500 focus:border-emerald-500 text-slate-100 w-64 md:w-80"
    />
  );
});

const MemberCard = memo(function MemberCard({
  teamColor, member,
  setNameRef, setScoreRef,
  onRemove, onCommitName, onAddScore, onUndo,
  nameTab, scoreTab,
  focusNextName, focusNextScore,
  disabled=false
}){
  const [nameDraft, setNameDraft] = useState(member.name);
  useEffect(()=>{ setNameDraft(member.name); },[member.name]);
  const commitName = ()=> onCommitName(nameDraft);

  const [scoreDraft, setScoreDraft] = useState("");
  const commitScore = ()=>{
    if(!scoreDraft.trim()) return;
    const n = clampInt(scoreDraft);
    if(n>=0) onAddScore(n);
    setScoreDraft("");
  };

  return (
    <div className="relative p-2 md:p-3 rounded-2xl shadow border border-slate-700 bg-slate-800 text-center" style={{ boxShadow:`0 0 0 1px ${teamColor}` }}>
      <button onClick={onRemove} disabled={disabled} className="absolute top-1 right-1 md:top-2 md:right-2 rounded-md border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-50 text-[10px] md:text-xs px-1.5 py-0.5" title="Remove member">√ó</button>
      <div className="flex items-center justify-center gap-2 mb-1 md:mb-2">
        <input
          ref={(el)=> setNameRef(member.id, el)}
          tabIndex={nameTab}
          value={nameDraft}
          disabled={disabled}
          onFocus={(e)=> e.target.select()}
          onChange={(e)=> setNameDraft(e.target.value)}
          onKeyDown={(e)=>{
            if(e.key==="Enter"){ e.preventDefault(); commitName(); }
            if(e.key==="Tab"){ e.preventDefault(); commitName(); focusNextName(e.shiftKey); }
          }}
          onBlur={commitName}
          className="font-bold text-xl md:text-2xl px-1 py-1 bg-transparent text-center outline-none border-b-2 border-slate-600 hover:border-slate-500 focus:border-emerald-500 text-slate-100 w-3/4 disabled:opacity-60"
        />
      </div>
      <div className="text-[10px] md:text-xs uppercase tracking-wide opacity-70">Subtotal</div>
      <div className="text-4xl md:text-5xl font-bold tabular-nums">{sum(member.entries)}</div>

      <div className="mt-2">
        <div className="text-[10px] md:text-xs uppercase tracking-wide opacity-70 mb-1 text-center">Per-turn</div>
        <ul className="min-h-[1.25rem] md:min-h-[1.75rem] space-y-0.5 max-h-24 md:max-h-28 overflow-auto pr-1">
          {member.entries.map((v,i)=>(<li key={i} className="text-[11px] md:text-sm tabular-nums">{v}</li>))}
        </ul>
        <div className="mt-2 flex items-center gap-2">
          <input
            ref={(el)=> setScoreRef(member.id, el)}
            tabIndex={scoreTab}
            type="text" inputMode="numeric" pattern="[0-9]*"
            value={scoreDraft}
            disabled={disabled}
            onChange={(e)=> setScoreDraft((e.target.value||"").replace(/\D+/g,""))}
            onKeyDown={(e)=>{
              if(e.key==="Enter"){ e.preventDefault(); commitScore(); }
              else if(e.key==="Tab"){ e.preventDefault(); commitScore(); focusNextScore(e.shiftKey); }
            }}
            className="flex-1 min-w-0 h-12 md:h-10 text-lg md:text-base px-3 py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 placeholder-slate-400 outline-none focus:ring-2 focus:ring-emerald-600 disabled:opacity-60"
            placeholder="score"
          />
          <button onClick={onUndo} disabled={disabled} className="w-10 h-10 grid place-items-center rounded-2xl border border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700 disabled:opacity-50 text-base" title="Undo last" aria-label="Undo last">‚Ü∂</button>
        </div>
      </div>
    </div>
  );
});

// ---------- Desktop (top-level component; stable identity) ----------
const Desktop = memo(function Desktop({
  app, onUndo, onReset,
  addMember, removeMember, renameTeam, commitMemberName,
  addScore, undoMember,
  openColor
}){
  const nameOrder = useMemo(()=>{
    const order=[]; for(const t of app.teams) for(const m of t.members) order.push({memberId:m.id, teamId:t.id}); return order;
  },[app.teams]);
  const nameIndex = useMemo(()=>{ const m=new Map(); nameOrder.forEach((o,i)=>m.set(o.memberId,i)); return m; },[nameOrder]);
  const scoreOrder = useMemo(()=>{
    const teams=app.teams; const maxRows=Math.max(0,...teams.map(t=>t.members.length)); const order=[];
    for(let r=0;r<maxRows;r++) for(const t of teams){ const m=t.members[r]; if(m) order.push({memberId:m.id, teamId:t.id}); }
    return order;
  },[app.teams]);
  const scoreIndex = useMemo(()=>{ const m=new Map(); scoreOrder.forEach((o,i)=>m.set(o.memberId,i)); return m; },[scoreOrder]);
  const nameRefs = useRef({}); const setNameRef = (id,el)=> (nameRefs.current[id]=el);
  const scoreRefs = useRef({}); const setScoreRef = (id,el)=> (scoreRefs.current[id]=el);

  const teamTotal = (team)=> sum(team.members.flatMap(m=>m.entries)) + sum(team.teamEntries||[]);

  return (
    <div className="hidden md:block">
      <header className="grid grid-cols-3 items-center mb-4 md:mb-6">
        <div className="justify-self-start"><h1 className="text-2xl md:text-3xl font-bold tracking-tight">Pig Scorekeeper</h1></div>
        <div className="justify-self-center">
          <div className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100 text-sm md:text-base whitespace-nowrap">
            <span className="font-semibold">Goal:</span> First to 100 points wins!
          </div>
        </div>
        <div className="justify-self-end flex items-center gap-2">
          <button onClick={onUndo} disabled={!app.history.length} className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100 disabled:opacity-50">Undo</button>
          <button onClick={onReset} className="px-3 py-2 rounded-2xl border border-slate-700 bg-slate-800 text-slate-100">Reset</button>
        </div>
      </header>
      <div className="grid md:grid-cols-2 gap-6">
        {app.teams.map(team => {
          const members = team.members;
          const cols = Math.max(1, members.length);
          const total = teamTotal(team);
          const isWinner = app.winnerTeamId === team.id;
          return (
            <div key={team.id} className={"p-3 md:p-4 rounded-2xl shadow border bg-slate-800 " + (isWinner ? "ring-4 ring-yellow-400" : "border-slate-700")} style={{ boxShadow:`0 0 0 1px ${team.color}` }}>
              <div className="mb-2 md:mb-3">
                <div className="flex items-center justify-between gap-2 relative">
                  <div className="flex-1" />
                  <div className="flex items-center gap-3 relative">
                    <button onClick={()=>openColor(team.id)} className="w-7 h-7 md:w-8 md:h-8 rounded-full border border-slate-700 shrink-0" style={{ background: team.color }} title="Pick team color"></button>
                    <div className="flex flex-col items-center gap-1">
                      <TeamNameInput value={team.name} onCommit={(v)=> renameTeam(team.id, v)} />
                      <div className="text-xs font-medium" style={{ color: team.color }}>{isWinner ? "üèÜ Winner" : "Team"}</div>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <span className="text-xs uppercase tracking-wide opacity-70">{members.length}/{MAX_MEMBERS}</span>
                  </div>
                </div>
              </div>

              <div className="p-3 rounded-2xl shadow border border-slate-700 bg-slate-800 text-center min-h-[200px]" style={{ boxShadow:`0 0 0 1px ${team.color}` }}>
                <div className="text-xs md:text-sm uppercase tracking-wide opacity-70">Team total</div>
                <div className={"tabular-nums text-white leading-none " + (isWinner ? "text-9xl animate-pulse" : "text-8xl font-black")}>{total}</div>
                <div className="inline-block px-2 py-1 rounded-lg text-sm md:text-base mt-2" style={{ background:'rgba(255,255,255,0.08)', color:team.color }}>
                  {Math.max(0,100-total)} to 100
                </div>
              </div>

              <div className="mt-3 grid gap-2 md:gap-3" style={{ gridTemplateColumns:`repeat(${cols}, minmax(0, 1fr))` }}>
                {members.map(m => (
                  <MemberCard
                    key={m.id}
                    teamColor={team.color}
                    member={m}
                    setNameRef={(id,el)=> setNameRef(id,el)}
                    setScoreRef={(id,el)=> setScoreRef(id,el)}
                    onRemove={()=>removeMember(team.id,m.id)}
                    onCommitName={(v)=>commitMemberName(m.id,v)}
                    onAddScore={(n)=>addScore(team.id,m.id,n)}
                    onUndo={()=>undoMember(team.id,m.id)}
                    nameTab={100 + (nameIndex.get(m.id) ?? 0)}
                    scoreTab={200 + (scoreIndex.get(m.id) ?? 0)}
                    focusNextName={(shift)=>{
                      const idx = nameIndex.get(m.id) ?? 0;
                      const nextIdx = (idx + (shift?-1:1) + nameOrder.length) % nameOrder.length;
                      const nextId = nameOrder[nextIdx].memberId;
                      requestAnimationFrame(()=> nameRefs.current[nextId]?.focus());
                    }}
                    focusNextScore={(shift)=>{
                      const idx = scoreIndex.get(m.id) ?? 0;
                      const nextIdx = (idx + (shift?-1:1) + scoreOrder.length) % scoreOrder.length;
                      const nextId = scoreOrder[nextIdx].memberId;
                      requestAnimationFrame(()=> scoreRefs.current[nextId]?.focus());
                    }}
                    disabled={!!app.winnerTeamId}
                  />
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
});

// ---------- Mobile (top-level component; stable identity) ----------
const Mobile = memo(function Mobile({
  app, onUndo, onReset, openColor, addTeamScore, undoLastTeam
}){
  // keep dock above keyboard
  const refDock = useRef(null);
  useEffect(()=>{
    const vv = window.visualViewport;
    if (!vv || !refDock.current) return;
    const el = refDock.current;
    let raf=null;
    const apply=()=>{ const kb=Math.max(0, window.innerHeight - vv.height - vv.offsetTop); el.style.bottom = kb + "px"; raf=null; };
    const onRes=()=>{ if(!raf) raf=requestAnimationFrame(apply); };
    vv.addEventListener('resize', onRes); apply();
    return ()=> { vv.removeEventListener('resize', onRes); if(raf) cancelAnimationFrame(raf); };
  },[]);

  // single always-focused input
  const inputRef = useRef(null);
  const bufRef = useRef(""); // latest digits
  const [activeIdx, setActiveIdx] = useState(0);

  useEffect(()=>{ requestAnimationFrame(()=> inputRef.current?.focus({ preventScroll: true })); },[]);
  useEffect(()=>{
    // keep focus after flip
    requestAnimationFrame(()=> inputRef.current?.focus({ preventScroll: true }));
  }, [activeIdx]);

  const totalOf = (t) => sum(t.members.flatMap(m=>m.entries)) + sum(t.teamEntries||[]);

  const commitFromBuffer = () => {
    if (app.winnerTeamId) return false; // lock after win
    const digits = bufRef.current.trim();
    if (!digits) return false;
    const n = clampInt(digits);
    const t = app.teams[activeIdx];
    if (!t) return false;
    addTeamScore(t.id, n);
    // clear field but keep focus
    if (inputRef.current) inputRef.current.value = "";
    bufRef.current = "";
    return true;
  };

  const handleAdd = () => {
    // wait one frame so IME commits last key, then read & flip
    requestAnimationFrame(()=>{
      const ok = commitFromBuffer();
      if (ok) setActiveIdx(i => (i+1) % app.teams.length);
      requestAnimationFrame(()=> inputRef.current?.focus({ preventScroll: true }));
    });
  };

  return (
    <div className="md:hidden">
      {/* Top bar */}
      <div className="fixed top-0 left-0 right-0 z-40 border-b border-slate-700 bg-slate-900/95 backdrop-blur">
        <div className="px-3 py-2 flex items-center justify-between text-slate-300">
          <div className="text-[12px]">Goal: First to 100 points wins!</div>
          <div className="flex items-center gap-2">
            <button onClick={onUndo} disabled={!app.history.length} className="px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-700 text-xs disabled:opacity-50">Undo</button>
            <button onClick={onReset} className="px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-700 text-xs">Reset</button>
          </div>
        </div>
        {/* Score tiles */}
        <div className="px-3 pb-2 grid grid-cols-2 gap-3">
          {app.teams.map((t)=> {
            const total = totalOf(t);
            const isWinner = app.winnerTeamId === t.id;
            return (
              <div key={t.id} className={"p-2 rounded-2xl border bg-slate-800 " + (isWinner ? "ring-4 ring-yellow-400" : "border-slate-700")} style={{ boxShadow: `0 0 0 1px ${t.color}` }}>
                <div className="flex items-center justify-between">
                  <button onClick={()=>openColor(t.id)} className="w-6 h-6 rounded-full border border-slate-700" style={{ background: t.color }} title="Pick team color"></button>
                  <div className="text-base text-slate-300">{isWinner ? "üèÜ Winner" : "to 100:"} <span className="font-semibold" style={{ color: t.color }}>{isWinner ? "" : Math.max(0, 100 - total)}</span></div>
                </div>
                <div className="mt-1 text-center">
                  <div className="text-[10px] uppercase tracking-wide opacity-70">{t.name}</div>
                  <div className={"tabular-nums text-white leading-none " + (isWinner ? "text-8xl animate-pulse" : "text-7xl font-black")}>{total}</div>
                </div>
                <div className="mt-1 flex items-center justify-center gap-2">
                  <button onClick={()=>undoLastTeam(t.id)} disabled={!!app.winnerTeamId} className="px-2 py-1 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700 text-xs disabled:opacity-50">‚Ü∂ Undo</button>
                  <button onClick={()=>openColor(t.id)} className="px-2 py-1 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700 text-xs">üé®</button>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Spacer under top tiles */}
      <div className="pt-[190px]"></div>

      {/* Bottom dock */}
      <div ref={refDock} className="fixed left-0 right-0 z-50 border-t border-slate-700 bg-slate-900/95 backdrop-blur" style={{ bottom: 0 }}>
        <div className="max-w-7xl mx-auto px-3 py-3 relative">
          <div className="flex items-center gap-2">
            <div className="px-2 py-1 rounded-lg border border-slate-700 bg-slate-800 text-xs whitespace-nowrap" style={{ color: app.teams[activeIdx]?.color || "#94a3b8" }}>
              Active: <span className="font-semibold">{app.teams[activeIdx]?.name || ""}</span>
            </div>
            <input
              ref={inputRef}
              type="tel" inputMode="numeric" pattern="[0-9]*"
              enterKeyHint="next"
              autoComplete="off" autoCorrect="off" autoCapitalize="off" spellCheck="false"
              placeholder={app.teams[activeIdx] ? ("Add " + app.teams[activeIdx].name + " score") : "Add score"}
              defaultValue=""
              disabled={!!app.winnerTeamId}
              onInput={(e)=>{
                const digits = (e.currentTarget.value || "").replace(/\D+/g,"");
                if (digits !== e.currentTarget.value) {
                  const start = e.currentTarget.selectionStart;
                  const end = e.currentTarget.selectionEnd;
                  e.currentTarget.value = digits;
                  try { e.currentTarget.setSelectionRange(start-1, end-1); } catch {}
                }
                bufRef.current = digits;
              }}
              onKeyDown={(e)=>{
                if (e.key === "Enter") { e.preventDefault(); e.stopPropagation(); handleAdd(); }
              }}
              onKeyUp={(e)=>{
                if (e.key === "Enter") requestAnimationFrame(()=> inputRef.current?.focus({ preventScroll: true }));
              }}
              className="flex-1 min-w-0 h-12 px-3 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 outline-none focus:ring-2 focus:ring-emerald-600 no-focus-outline disabled:opacity-60"
            />
            <button
              type="button"
              tabIndex="-1"
              onPointerDown={(e)=> { e.preventDefault(); e.stopPropagation(); }}
              onClick={handleAdd}
              disabled={!!app.winnerTeamId}
              className="px-3 h-12 rounded-xl border border-slate-700 bg-slate-800 hover:bg-slate-700 disabled:opacity-50">Add ‚Ü¶</button>
            <button
              type="button"
              tabIndex="-1"
              onPointerDown={(e)=> { e.preventDefault(); e.stopPropagation(); }}
              onClick={()=> { setActiveIdx(i => (i+1)%app.teams.length); requestAnimationFrame(()=> inputRef.current?.focus({ preventScroll: true })); }}
              disabled={!!app.winnerTeamId}
              className="px-2 h-12 rounded-xl border border-slate-700 bg-slate-800 hover:bg-slate-700 disabled:opacity-50" title="Switch team">‚Üî</button>
          </div>
          <div className="absolute right-2 -bottom-5 text-[10px] text-slate-400 opacity-70">{APP_VERSION}</div>
        </div>
      </div>
    </div>
  );
});

// ---------- App (parent) ----------
function App(){
  const [app,setApp] = usePersistedState({
    target:100,
    winnerTeamId:null,
    teams:[
      { id:uid(), name:"Team A", color:"#38bdf8", teamEntries:[], members:[
        {id:uid(), name:"Member 1", entries:[]},
        {id:uid(), name:"Member 2", entries:[]},
        {id:uid(), name:"Member 3", entries:[]},
      ]},
      { id:uid(), name:"Team B", color:"#f472b6", teamEntries:[], members:[
        {id:uid(), name:"Member 1", entries:[]},
        {id:uid(), name:"Member 2", entries:[]},
        {id:uid(), name:"Member 3", entries:[]},
      ]},
    ],
    history:[],
  });

  // helpers
  const teamTotal = (team)=> sum(team.members.flatMap(m=>m.entries)) + sum(team.teamEntries||[]);
  const snapshot = (p)=> JSON.parse(JSON.stringify({ winnerTeamId: p.winnerTeamId, teams: p.teams, target: p.target }));
  const pushHistory = ()=> setApp(p => ({ ...p, history: [...p.history.slice(-49), snapshot(p)] }));
  const checkWinner = (teams, prevWinner) => {
    if (prevWinner) return prevWinner;
    for (const t of teams) {
      if (teamTotal(t) >= (app.target||100)) return t.id;
    }
    return null;
  };

  const onUndo = ()=> setApp(p => {
    if (!p.history.length) return p;
    const last = p.history[p.history.length-1];
    return { ...p, teams: last.teams, target: last.target, winnerTeamId: last.winnerTeamId ?? null, history: p.history.slice(0,-1) };
  });
  const onReset = ()=> {
    if (!confirm("Reset scores (no archive)?")) return;
    pushHistory();
    setApp(p => ({ ...p, winnerTeamId:null, teams: p.teams.map(t => ({ ...t, teamEntries: [], members: t.members.map(m => ({ ...m, entries: [] })) })) }));
  };

  // team/member mutations with winner check
  const addMember = (teamId)=> { if (app.winnerTeamId) return; pushHistory(); setApp(p=>({...p, teams:p.teams.map(t=> t.id===teamId ? {...t, members: t.members.length>=MAX_MEMBERS ? t.members : [...t.members,{id:uid(),name:`Member ${t.members.length+1}`,entries:[]}]} : t)})); };
  const removeMember = (teamId, memberId)=> { if (app.winnerTeamId) return; pushHistory(); setApp(p=>({...p, teams:p.teams.map(t=> t.id===teamId ? {...t, members: t.members.filter(m=>m.id!==memberId)} : t) })); };
  const renameTeam = (teamId, name)=> setApp(p=>({...p, teams:p.teams.map(t=> t.id===teamId ? {...t, name} : t)}));
  const commitMemberName = (memberId, name)=> { if (app.winnerTeamId) return; pushHistory(); setApp(p=>({...p, teams:p.teams.map(t=> ({...t, members:t.members.map(m=> m.id===memberId ? {...m, name} : m)}))})); };
  const addScore = (teamId, memberId, n)=> {
    if (app.winnerTeamId) return;
    pushHistory();
    setApp(p=>{
      const teams = p.teams.map(t=> t.id===teamId ? {...t, members:t.members.map(m=> m.id===memberId ? {...m, entries:[...m.entries, n]} : m)} : t);
      const winner = checkWinner(teams, p.winnerTeamId);
      return {...p, teams, winnerTeamId: winner };
    });
  };
  const undoMember = (teamId, memberId)=> { pushHistory(); setApp(p=>({...p, teams:p.teams.map(t=> t.id===teamId ? {...t, members:t.members.map(m=> m.id===memberId ? {...m, entries:m.entries.slice(0,-1)} : m)} : t)})); };
  const addTeamScore = (teamId, n)=> {
    if (app.winnerTeamId) return;
    pushHistory();
    setApp(p=>{
      const teams = p.teams.map(t => t.id===teamId ? { ...t, teamEntries:[...(t.teamEntries||[]), n] } : t);
      const winner = checkWinner(teams, p.winnerTeamId);
      return { ...p, teams, winnerTeamId: winner };
    });
  };
  const undoLastTeam = (teamId)=> { pushHistory(); setApp(p=> ({ ...p, teams: p.teams.map(t => t.id===teamId ? { ...t, teamEntries:(t.teamEntries||[]).slice(0,-1) } : t) })); };

  // color picker
  const [pickerTeamId, setPickerTeamId] = useState(null);
  const pickerTeam = pickerTeamId ? app.teams.find(t => t.id === pickerTeamId) : null;

  // Winner overlay state
  const [showWinnerOverlay, setShowWinnerOverlay] = useState(false);
  const winnerTeam = app.winnerTeamId ? app.teams.find(t => t.id === app.winnerTeamId) : null;

  // open overlay when winner set
  useEffect(()=>{
    if (app.winnerTeamId) setShowWinnerOverlay(true);
  }, [app.winnerTeamId]);

  return (
    <div className="min-h-screen w-full text-slate-100">
      <div className="max-w-7xl mx-auto p-3 md:p-6">
        {/* Desktop */}
        <Desktop
          app={app}
          onUndo={onUndo}
          onReset={onReset}
          addMember={addMember}
          removeMember={removeMember}
          renameTeam={renameTeam}
          commitMemberName={commitMemberName}
          addScore={addScore}
          undoMember={undoMember}
          openColor={setPickerTeamId}
        />
        {/* Mobile */}
        <Mobile
          app={app}
          onUndo={onUndo}
          onReset={onReset}
          openColor={setPickerTeamId}
          addTeamScore={addTeamScore}
          undoLastTeam={undoLastTeam}
        />
      </div>
      <div className="fixed right-3 bottom-3 z-40 text-xs text-slate-400 opacity-70 select-none">{APP_VERSION}</div>

      {pickerTeam && (
        <WheelPicker
          initial={pickerTeam.color}
          onInput={(hex)=> setApp(p=> ({ ...p, teams: p.teams.map(t=> t.id===pickerTeam.id ? { ...t, color: hex } : t) }))}
          onClose={()=> setPickerTeamId(null)}
        />
      )}

      {showWinnerOverlay && winnerTeam && (
        <WinnerOverlay
          team={winnerTeam}
          onClose={()=> setShowWinnerOverlay(false)}
          onReset={onReset}
        />
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
